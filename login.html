<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö EGAT OT</title>
  <link rel="stylesheet" href="assets/css/style.css?v=18.7.1" />
</head>
<body>
  <div class="login-wrap">
    <div class="login-card">
      <h1>EGAT OT</h1>
      <p class="note">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>

      <button id="btn-passkey-login">üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢ Passkey</button>
      <div class="sep"></div>
      <p>‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ PIN 6 ‡∏´‡∏•‡∏±‡∏Å</p>
      <input type="password" id="pin" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus />
      <button id="loginBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (PIN)</button>
      <div class="hint">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: <b>000000</b></div>

      <div class="sep"></div>
      <button id="btn-passkey-register" class="ghost">‚ûï ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Passkey ‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ</button>
      <p class="note">* ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô HTTPS/‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ä‡πà‡∏ô GitHub Pages) ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</p>
    </div>
  </div>

<script>
var VERSION='18.7.1';
var SESSION_KEY='ot_session_auth_v1';
var PIN_KEY='ot_pin';
var PASSKEY_STORE='ot_webauthn_cred';
function goApp(){ sessionStorage.setItem(SESSION_KEY,'ok'); location.href='index.html?v='+VERSION; }

var defPin=localStorage.getItem(PIN_KEY)||'000000';
document.getElementById('loginBtn').addEventListener('click',function(){
  var pin=document.getElementById('pin').value.trim();
  if(pin===defPin){ goApp(); } else alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
});

function b64uToBytes(b64u){ b64u=b64u.replace(/-/g,'+').replace(/_/g,'/'); var pad=''; while((b64u.length+pad.length)%4) pad+='='; var str=atob(b64u+pad); var arr=new Uint8Array(str.length); for(var i=0;i<str.length;i++) arr[i]=str.charCodeAt(i); return arr; }
function bytesToB64u(buf){ var bin=''; var bytes=new Uint8Array(buf); for(var i=0;i<bytes.byteLength;i++) bin+=String.fromCharCode(bytes[i]); return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }

document.getElementById('btn-passkey-register').addEventListener('click', async function(){
  if(!('credentials' in navigator) || !window.PublicKeyCredential){ alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö WebAuthn'); return; }
  try{
    var challenge = crypto.getRandomValues(new Uint8Array(32));
    var userId = crypto.getRandomValues(new Uint8Array(16));
    var pubKey = { challenge: challenge, rp: { name: 'EGAT OT', id: location.hostname },
      user: { id: userId, name: 'user@'+location.hostname, displayName: 'EGAT User' },
      pubKeyCredParams: [ { type:'public-key', alg:-7 }, { type:'public-key', alg:-257 } ],
      timeout: 60000, authenticatorSelection: { userVerification: 'preferred' }, attestation: 'none' };
    var cred = await navigator.credentials.create({ publicKey: pubKey });
    var rawIdB64u = bytesToB64u(cred.rawId);
    localStorage.setItem(PASSKEY_STORE, JSON.stringify({ id: rawIdB64u, rpId: location.hostname }));
    alert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Passkey ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úî');
  }catch(e){ alert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e); }
});

document.getElementById('btn-passkey-login').addEventListener('click', async function(){
  var saved = null; try{ saved = JSON.parse(localStorage.getItem(PASSKEY_STORE)||'null'); }catch(e){}
  if(!saved){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Passkey ‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ'); return; }
  try{
    var challenge = crypto.getRandomValues(new Uint8Array(32));
    var getReq = { challenge: challenge, rpId: saved.rpId || location.hostname, allowCredentials: [ { id: b64uToBytes(saved.id), type:'public-key' } ], userVerification: 'preferred', timeout: 60000 };
    await navigator.credentials.get({ publicKey: getReq });
    goApp();
  }catch(e){ alert('‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e); }
});
</script>
</body>
</html>
